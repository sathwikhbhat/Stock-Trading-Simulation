<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${stock.name} + ' - Stock Details'">Stock Details - Stock Trading Simulation</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        /* Simple, clean styling */
        .stock-chart-container {
            height: 400px;
            margin: 20px 0;
            position: relative;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .price-up {
            color: #198754;
        }
        .price-down {
            color: #dc3545;
        }
        .btn-chart-period {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .chart-type-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .chart-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        .chart-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .chart-overlay.hidden {
            display: none;
        }
        .price-badge {
            font-size: 1.2rem;
            padding: 0.35rem 0.5rem;
        }
        .volume-badge {
            background-color: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Stock Trading Simulator</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/}">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/stocks}">Market</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/portfolio}">Portfolio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/portfolio/performance}">Performance</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center text-white">
                    <span class="me-3"><i class="bi bi-person-circle me-1"></i> <span th:text="${user.username}">Username</span></span>
                    <span class="me-3"><i class="bi bi-cash-coin me-1"></i> $<span th:text="${#numbers.formatDecimal(user.accountBalance,1,2)}">10,000.00</span></span>
                    <a th:href="@{/logout}" class="btn btn-sm btn-outline-light">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Alerts -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Stock Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="d-flex align-items-center">
                                    <h2 class="mb-0" th:text="${stock.name}">Apple Inc.</h2>
                                    <span class="badge bg-secondary ms-2" th:text="${stock.symbol}">AAPL</span>
                                </div>
                                <div class="text-muted mt-1">
                                    <span id="last-updated">Last update: just now</span>
                                </div>
                            </div>
                            <div class="text-end price-change-container">
                                <h3 class="mb-1">$<span id="current-price" th:text="${#numbers.formatDecimal(stock.currentPrice,1,2)}">150.50</span></h3>
                                <div class="value-change" id="price-change-container">
                                    <span class="price-arrow"></span>
                                    <span id="price-change">0.00</span>
                                    <span class="price-percentage">(<span id="price-percentage">0.00</span>%)</span>
                                </div>
                                <div class="mt-2">
                                    <span class="badge bg-secondary">Volume: <span id="current-volume" th:text="${#numbers.formatInteger(stock.volume,1,'COMMA')}">1,000,000</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Replace the price chart section completely -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">Stock Price Chart</h5>
                    </div>
                    <div class="card-body">
                        <div id="chart-container" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Actions -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Buy Stock</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/stocks/buy}" method="post">
                            <input type="hidden" name="stockId" th:value="${stock.id}">
                            <div class="form-group mb-3">
                                <label for="buyQuantity">Quantity</label>
                                <input type="number" class="form-control" id="buyQuantity" name="quantity" min="1" value="1" required>
                            </div>
                            <div class="mb-3">
                                <p>Current Price: $<span id="buy-current-price" th:text="${#numbers.formatDecimal(stock.currentPrice,1,2)}">150.50</span></p>
                                <p>Total Cost: $<span id="buyTotalCost" th:text="${#numbers.formatDecimal(stock.currentPrice,1,2)}">150.50</span></p>
                            </div>
                            <button type="submit" class="btn btn-success w-100">Buy</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">Sell Stock</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/stocks/sell}" method="post">
                            <input type="hidden" name="stockId" th:value="${stock.id}">
                            <div class="form-group mb-3">
                                <label for="sellQuantity">Quantity</label>
                                <input type="number" class="form-control" id="sellQuantity" name="quantity" min="1" value="1" required>
                            </div>
                            <div class="mb-3">
                                <p>Current Price: $<span id="sell-current-price" th:text="${#numbers.formatDecimal(stock.currentPrice,1,2)}">150.50</span></p>
                                <p>Total Value: $<span id="sellTotalValue" th:text="${#numbers.formatDecimal(stock.currentPrice,1,2)}">150.50</span></p>
                            </div>
                            <button type="submit" class="btn btn-danger w-100">Sell</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-light text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2025 Stock Trading Simulation.</p>
        </div>
    </footer>

    <!-- Add back the missing script tags before ApexCharts -->
    <!-- SockJS and STOMP for WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stomp-websocket@2.3.4-next/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ApexCharts library -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        // Basic variables and configuration
        const stockId = /*[[${stock.id}]]*/ '1';
        const stockSymbol = /*[[${stock.symbol}]]*/ 'AAPL';
        const initialPrice = /*[[${stock.currentPrice}]]*/ 150.50;
        let currentPrice = parseFloat(initialPrice);
        let chartData = [];
        let chart = null;
        
        // DOM elements
        const priceElement = document.getElementById('current-price');
        const volumeElement = document.getElementById('current-volume');
        const buyPriceElement = document.getElementById('buy-current-price');
        const sellPriceElement = document.getElementById('sell-current-price');
        const buyQuantityInput = document.getElementById('buyQuantity');
        const sellQuantityInput = document.getElementById('sellQuantity');
        const buyTotalCost = document.getElementById('buyTotalCost');
        const sellTotalValue = document.getElementById('sellTotalValue');
        const lastUpdateElement = document.getElementById('last-updated');
        const chartContainer = document.getElementById('chart-container');
        
        // Current active timeframe
        let currentTimeframe = '1D';
        
        // Simple throttle function to prevent too many updates
        function throttle(func, delay) {
            let lastCall = 0;
            return function(...args) {
                const now = new Date().getTime();
                if (now - lastCall >= delay) {
                    lastCall = now;
                    return func(...args);
                }
            };
        }
        
        // ====== FETCH HISTORICAL DATA AND INITIALIZE CHART ======
        function initializeChart() {
            console.log("Initializing chart...");
            // Show loading indicator
            chartContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="height: 400px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            
            // Fetch historical price data
            fetch(`/stocks/${stockId}/history`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data || !data.data || !data.data.length) {
                        throw new Error('No historical data available');
                    }
                    
                    console.log("Historical data received:", data.data.length, "data points");
                    
                    // Process the data for the chart
                    chartData = data.data.map(point => ({
                        x: new Date(parseInt(point.x)),
                        y: parseFloat(point.y).toFixed(2)
                    }));
                    
                    // Sort the data by timestamp
                    chartData.sort((a, b) => a.x - b.x);
                    
                    // Create the chart
                    createChart(chartData);
                })
                .catch(error => {
                    console.error("Error initializing chart:", error);
                    chartContainer.innerHTML = `<div class="alert alert-danger">Failed to load chart: ${error.message}</div>`;
                });
        }
        
        // ====== CREATE THE ACTUAL CHART ======
        function createChart(data) {
            console.log("Creating chart with", data.length, "data points");
            
            // Filter data based on timeframe
            const filteredData = filterDataByTimeframe(data, currentTimeframe);
            
            // Clear previous chart if it exists
            if (chart) {
                chart.destroy();
            }
            
            // ApexCharts options
            const options = {
                series: [{
                    name: stockSymbol,
                    data: filteredData
                }],
                chart: {
                    type: 'area',
                    height: 400,
                    zoom: {
                        enabled: true,
                        type: 'x'
                    },
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 800,
                        dynamicAnimation: {
                            enabled: true,
                            speed: 350
                        }
                    },
                    toolbar: {
                        show: true,
                        tools: {
                            download: false,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0.3,
                        stops: [0, 90, 100]
                    }
                },
                colors: ['#0d6efd'],
                title: {
                    text: `${stockSymbol} Price History`,
                    align: 'left',
                    style: {
                        fontSize: '16px',
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    x: {
                        format: 'MMM dd, yyyy HH:mm'
                    },
                    y: {
                        formatter: function (value) {
                            return '$' + value;
                        }
                    }
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeUTC: false
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (value) {
                            return '$' + value.toFixed(2);
                        }
                    },
                    title: {
                        text: 'Price (USD)'
                    }
                }
            };
            
            // Create the chart
            chart = new ApexCharts(chartContainer, options);
            chart.render();
            
            console.log("Chart created successfully");
        }
        
        // ====== FILTER DATA BASED ON TIMEFRAME ======
        function filterDataByTimeframe(data, timeframe) {
            if (data.length === 0) return [];
            
            const now = new Date();
            let cutoffDate = new Date();
            
            // Determine cutoff date based on timeframe
            switch(timeframe) {
                case '1D':
                    cutoffDate.setDate(now.getDate() - 1);
                    break;
                case '1W':
                    cutoffDate.setDate(now.getDate() - 7);
                    break;
                case '1M':
                    cutoffDate.setMonth(now.getMonth() - 1);
                    break;
                case 'ALL':
                    return data; // Return all data
                default:
                    cutoffDate.setMonth(now.getMonth() - 1); // Default to 1 month
            }
            
            return data.filter(point => point.x >= cutoffDate);
        }
        
        // ====== UPDATE CHART BASED ON TIMEFRAME ======
        function updateChartTimeframe(timeframe) {
            if (!chart || chartData.length === 0) return;
            
            console.log(`Updating chart timeframe to ${timeframe}`);
            
            const filteredData = filterDataByTimeframe(chartData, timeframe);
            chart.updateSeries([{
                name: stockSymbol,
                data: filteredData
            }]);
        }
        
        // ====== ADD REAL-TIME PRICE UPDATE TO CHART ======
        function addPriceToChart(price) {
            if (!chart || chartData.length === 0) return;
            
            // Only add a point every 5 seconds to avoid too many updates
            const now = new Date();
            const newPoint = {
                x: now,
                y: parseFloat(price).toFixed(2)
            };
            
            // Add to our data array
            chartData.push(newPoint);
            
            // Only update the chart if the current view includes the latest data
            if (currentTimeframe !== 'ALL') {
                const filteredData = filterDataByTimeframe(chartData, currentTimeframe);
                chart.updateSeries([{
                    name: stockSymbol,
                    data: filteredData
                }]);
            } else {
                chart.appendData([{
                    name: stockSymbol,
                    data: [newPoint]
                }]);
            }
        }
        
        // Throttle the chart updates to improve performance
        const throttledAddPriceToChart = throttle(addPriceToChart, 5000);
        
        // ====== UPDATE STOCK PRICE FUNCTION ======
        function updateStockData(update) {
            try {
                if (!priceElement) return;
                
                // Get the old price for comparison
                const oldPrice = parseFloat(priceElement.textContent);
                const newPrice = parseFloat(update.currentPrice).toFixed(2);
                
                // Update displayed price
                priceElement.textContent = newPrice;
                currentPrice = parseFloat(newPrice);
                
                // Calculate change amount and percentage
                const priceChange = (newPrice - oldPrice).toFixed(2);
                const percentChange = ((newPrice - oldPrice) / oldPrice * 100).toFixed(2);
                
                // Update price change display
                const priceChangeElement = document.getElementById('price-change');
                const percentageElement = document.getElementById('price-percentage');
                const priceArrowElement = document.querySelector('.price-arrow');
                const changeContainer = document.getElementById('price-change-container');
                
                if (priceChangeElement && percentageElement) {
                    priceChangeElement.textContent = Math.abs(priceChange);
                    percentageElement.textContent = Math.abs(percentChange);
                    
                    if (priceChange > 0) {
                        changeContainer.classList.remove('negative');
                        changeContainer.classList.add('positive');
                        priceArrowElement.innerHTML = '▲';
                    } else if (priceChange < 0) {
                        changeContainer.classList.remove('positive');
                        changeContainer.classList.add('negative');
                        priceArrowElement.innerHTML = '▼';
                    }
                }
                
                // Add visual indication of price change
                if (newPrice > oldPrice) {
                    priceElement.classList.remove('text-danger');
                    priceElement.classList.add('text-success');
                } else if (newPrice < oldPrice) {
                    priceElement.classList.remove('text-success');
                    priceElement.classList.add('text-danger');
                }
                
                // Update price in buy/sell forms
                if (buyPriceElement) buyPriceElement.textContent = newPrice;
                if (sellPriceElement) sellPriceElement.textContent = newPrice;
                
                // Update last updated time
                if (lastUpdateElement) {
                    const now = new Date();
                    lastUpdateElement.textContent = `Last update: ${now.toLocaleTimeString()}`;
                }
                
                // Update volume display
                if (volumeElement) {
                    volumeElement.textContent = Number(update.volume).toLocaleString();
                }
                
                // Recalculate totals
                updateTotals();
                
                // Add the new price point to the chart (throttled)
                throttledAddPriceToChart(newPrice);
            } catch (error) {
                console.error('Error updating stock data:', error);
            }
        }
        
        // ====== WEBSOCKET CONNECTION ======
        function setupWebSocket() {
            console.log("Setting up WebSocket connection...");
            
            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);
            stompClient.debug = null; // Disable debug logging
            
            stompClient.connect({}, function(frame) {
                console.log('Connected to WebSocket');
                
                // Subscribe to stock updates
                stompClient.subscribe('/topic/stock-updates', function(message) {
                    try {
                        const updates = JSON.parse(message.body);
                        const thisStockUpdate = updates.find(update => update.id === stockId);
                        
                        if (thisStockUpdate) {
                            updateStockData(thisStockUpdate);
                        }
                    } catch (error) {
                        console.error('Error processing message:', error);
                    }
                });
                
                // Subscribe to pong responses to keep connection alive
                stompClient.subscribe('/topic/pong', function(message) {
                    console.log('Heartbeat received from server');
                });
                
                // Request initial data
                stompClient.send("/app/fetch-stocks", {}, {});
                
                // Setup heartbeat mechanism
                setupHeartbeat(stompClient);
                
            }, function(error) {
                console.error('STOMP error:', error);
                
                // Try to reconnect after a delay
                setTimeout(setupWebSocket, 5000);
            });
        }
        
        // Add heartbeat function to periodically ping the server
        function setupHeartbeat(stompClient) {
            // Send a ping every 20 seconds to keep the connection alive
            const heartbeatInterval = setInterval(() => {
                if (stompClient && stompClient.connected) {
                    try {
                        console.log('Sending heartbeat');
                        stompClient.send('/app/ping', {}, JSON.stringify({ 
                            action: 'ping', 
                            timestamp: Date.now(), 
                            stockId: stockId 
                        }));
                    } catch (err) {
                        console.error('Failed to send heartbeat, connection may be lost:', err);
                        clearInterval(heartbeatInterval);
                        setTimeout(setupWebSocket, 3000);
                    }
                } else {
                    console.warn('Connection lost, clearing heartbeat interval');
                    clearInterval(heartbeatInterval);
                    setTimeout(setupWebSocket, 3000);
                }
            }, 20000);
            
            // Store interval reference for potential cleanup
            window.heartbeatInterval = heartbeatInterval;
        }
        
        // ====== BUY/SELL FORM CALCULATIONS ======
        function updateTotals() {
            if (buyQuantityInput) {
                const buyQty = parseInt(buyQuantityInput.value) || 1;
                buyTotalCost.textContent = (currentPrice * buyQty).toFixed(2);
            }
            
            if (sellQuantityInput) {
                const sellQty = parseInt(sellQuantityInput.value) || 1;
                sellTotalValue.textContent = (currentPrice * sellQty).toFixed(2);
            }
        }
        
        if (buyQuantityInput) {
            buyQuantityInput.addEventListener('input', updateTotals);
        }
        
        if (sellQuantityInput) {
            sellQuantityInput.addEventListener('input', updateTotals);
        }
        
        // Initialize the page
        console.log("Initializing stock details page");
        updateTotals();
        initializeChart();
        setupWebSocket();
    });
    /*]]>*/
    </script>
</body>
</html> 